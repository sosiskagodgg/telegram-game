<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Telegram Clicker</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * { margin: 0; padding: 0; border: 0; }
        body { 
            text-align: center; 
            background: #000; 
            padding: 0;
            border: 0; 
            margin: 0;
        }
        #unity-canvas { 
            background: #231F20; 
        }
    </style>
</head>
<body style="text-align: center; padding: 0; border: 0; margin: 0;">
    <canvas id="unity-canvas" width="414" height="896" tabindex="-1" 
            style="width: 414px; height: 896px; background: #231F20; display: block;"></canvas>
    
    <script src="Build/telegram-game.loader.js"></script>
    <script>
        // Настройка для мобильных
        if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            var meta = document.createElement('meta');
            meta.name = 'viewport';
            meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
            document.getElementsByTagName('head')[0].appendChild(meta);

            var canvas = document.getElementById('unity-canvas');
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            canvas.style.position = "fixed";

            document.body.style.textAlign = "left";
        }
        
        // Функция для получения ID пользователя
        function getUserId() {
            // 1. Из Telegram
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
                var user = Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    console.log('Got Telegram ID:', user.id);
                    return user.id.toString();
                }
            }
            
            // 2. Из URL
            var urlParams = new URLSearchParams(window.location.search);
            var urlId = urlParams.get('user_id');
            if (urlId) {
                console.log('Got URL ID:', urlId);
                return urlId;
            }
            
            // 3. Не найден
            console.warn('User ID not found');
            return "-1";
        }
        
        // Запуск Unity
        createUnityInstance(document.getElementById('unity-canvas'), {
            dataUrl: "Build/telegram-game.data",
            frameworkUrl: "Build/telegram-game.framework.js",
            codeUrl: "Build/telegram-game.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "telegramTest",
            productVersion: "1.0",
        }).then((unityInstance) => {
            // Передаем ID в Unity после загрузки
            setTimeout(function() {
                var userId = getUserId();
                
                // Отправляем в Unity
                unityInstance.SendMessage('SaveAndLoad', 'SetUserId', userId);
                
                // Для отладки - глобальная функция
                window.sendUserId = function() {
                    unityInstance.SendMessage('SaveAndLoad', 'SetUserId', getUserId());
                };
                
                console.log('User ID sent to Unity:', userId);
            }, 1000); // Даем Unity время на инициализацию
            
        }).catch((error) => {
            alert('Error: ' + error);
            console.error(error);
        });
    </script>
</body>
</html>